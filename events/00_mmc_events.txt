namespace = mmc

character_event = { #Event to convert a holding into a military command
	id = mmc.10
	desc = EVTDESC_MMC_10
	picture = GFX_evt_spymaster
	border = GFX_event_normal_frame_intrigue
	is_triggered_only = yes #decision make_military
	hide_from = yes
	
	ai = no
	
	#ROOT - the title owner
	#FROM - the title to convert
	#FROMFROM - the decision maker
	#target_make_military - the title to convert
	
	trigger = {
		ROOT = { character = FROMFROM } #The event should be firing for the title holder
	}

	immediate = {
	
	}
	
	option = { #Convert
		name = EVTOPT_A_MMC_10
		custom_tooltip = {
			text = TOOLTIP_MMC_convert_military
			hidden_tooltip = {
				event_target:target_make_military = {
					set_title_flag = military_command
					set_title_flag = new_military_command #Used to track the temp military commands
				}
			}
		}
		# any_realm_character = { #Your family will be upset that you're not granting them titles
			# limit = {
				# is_ruler = no
				# is_close_relative = ROOT
				# is_liege_or_above = ROOT
				# age = 14
				# NOT = { trait = incapable }
				# OR = {
					# is_primary_heir = no
					# sibling = ROOT
				# }	
				# OR = {
					# is_female = no
					# ROOT = {
						# primary_title = {
							# OR = {
								# has_law = enatic_cognatic_succession
								# has_law = enatic_succession
							# }
						# }
					# }
					# AND = { #Females must be legitimate blood relatives to ask for titles under true cognatic
						# ROOT = { 
							# dynasty = PREV
							# primary_title = { has_law = true_cognatic_succession }
						# }
						# NOT = { trait = bastard }
					# }	
				# }
				# OR = {
					# is_female = yes
					# ROOT = {
						# primary_title = {
							# OR = {
								# has_law = cognatic_succession
								# has_law = agnatic_succession
								# has_law = true_cognatic_succession
							# }
						# }
					# }
				# }
				# OR = {	
					# has_ambition = obj_wants_landed_title
					# trait = ambitious
					# trait = familyperson
					# has_opinion_modifier = { who = ROOT modifier = opinion_promised_title }
					# has_opinion_modifier = { who = ROOT modifier = opinion_denied_title }
					# AND = {
						# OR = {
							# trait = proud
							# trait = envious
							# trait = greedy
						# }	
						# NOT = { trait = content }
					# }
				# }	
				# can_press_claims_trigger = yes
				# NOT = { trait = drowned }
				# NOT = { trait = disinherited }
				
				# #Some characters don't mind kin gaining title
				# NOR = {
					# is_close_relative = FROMFROM
					# OR = {
						# opinion = { who = FROMFROM value = 20 }
						# NOT = { is_older_than = FROMFROM }
					# }
					# OR = {
						# trait = just
						# trait = honorable
						# trait = familyperson
						# trait = patient
					# }
					# NOT = { trait = ambitious }
					# NOT = { trait = envious }
				# }
			# }	
			# opinion = {
				# who = ROOT
				# modifier = opinion_did_not_give_me_title
				# months = 60
			# }	
		# }
		# any_realm_character = { #Your vassals will be upset that you're trying to retain titles -- maybe tyranical even?
			# limit = {
				# is_ruler = yes
				# is_liege_or_above = ROOT
				# higher_real_tier_than = baron
				# NOR = {
					# is_close_relative = ROOT
					# dynasty = ROOT
				# }
			# }
			# opinion = {
				# who = ROOT
				# modifier = opinion_did_not_give_me_title #TODO: add a custom opinion later
				# months = 60
			# }
		# }
	}
	option = { #Don't convert
		name = EVTOPT_B_MMC_10
	}
	
	after = {
		clear_event_target = target_make_military
	}

}

character_event = { #This is a ping event to get the scoping correct for the unmilitary-ing
	id = mmc.20
	is_triggered_only = yes #decision unmake_military
	hide_window = yes 
	
	#ROOT - the title owner
	#FROM - the title to convert
	#FROMFROM - the decision maker
	#target_unmake_military - the title to convert
	
	trigger = {
		event_target:target_unmake_military = { owner = { character = ROOT } } #This event should be firing for the event of the title holder
	}

	option = {
		FROMFROM = { character_event = { id = mmc.25 } } #Send the event to the original decision maker
	}
}

character_event = { #This event converts a non-historical military command into a regular holding
	id = mmc.25
	picture = GFX_evt_spymaster
	is_triggered_only = yes #event mmc.20
	
	#ROOT - the decision maker
	#FROM - the title owner
	#FROMFROM - the title to convert
	#FROMFROMFROM - the decision maker
	#target_unmake_military - the title to convert
	
	desc = { #Convert my title
		trigger = { FROM = { character = ROOT } }
		text = EVTDESC_MMC_25.1
	}
	desc = { #Convert my vassal's title
		trigger = { NOT = { FROM = { character = ROOT } } }
		text = EVTDESC_MMC_25.2
	}
	
	trigger = {
		ai = no #Only players can do this -- for now
		FROM = { #This should be the title holder
			OR = {
				character = ROOT #Must either be owned by ROOT
				is_liege_or_above = ROOT #Or a vassal of ROOT
			}
		}
	}
	
	immediate = {
	
	}
	
	option = { #Convert my title
		name = EVTOPT_A_MMC_25
		trigger = { FROM = { character = ROOT } }
		custom_tooltip = {
			text = TOOLTIP_MMC_convert_regular
			hidden_tooltip = {
				event_target:target_unmake_military = {
					clr_title_flag = new_military_command
					clr_title_flag = military_command
				}
			}
		}
	}
	option = { #Convert my vassal's title
		name = EVTOPT_B_MMC_25
		trigger = { NOT = { FROM = { character = ROOT } } }
		custom_tooltip = {
			text = TOOLTIP_MMC_convert_regular
			hidden_tooltip = {
				event_target:target_unmake_military = {
					clr_title_flag = new_military_command
					clr_title_flag = military_command
				}
				FROM = {
					if = {
						limit = { primary_title = { event_target:target_unmake_military = { title = PREV } } }
						if = {
							limit = { event_target:target_unmake_military = { holding_type = castle } }
							set_government_type = feudal
							event_target:target_unmake_military = { succession = primogeniture }
						}
						else = {
							set_government_type = republic
							event_target:target_unmake_military = { succession = elective }
						}
					}
					recalc_succession = yes
				}
			}
		}
		FROM = {
			opinion = {
				who = ROOT
				modifier = opinion_granted_barony
				months = 60
			}
		}
	}
	option = { #Don't convert
		name = EVTOPT_C_MMC_25
	}
	
	after = {
		clear_event_target = target_unmake_military
	}

}

character_event = { # Used to ping to the granter
	id = mmc.100
	is_triggered_only = yes # fired title_mmc_marquis_dornish_marshes gain_effect
	hide_window = yes
	# Stack when fired by title grant
	# This - title holder
	# ROOT - title holder
	# FROM - title holder
	# FROMFROM - title granter
	
	trigger = {
		has_minor_title = title_mmc_marquis_dornish_marshes
	}
	
	immediate = {
		log = "Debug: event mmc.100"
		print_scope_effect = yes
		if = { # Try and find some random schmuck we can hate on
			limit = {
				any_realm_title = {
					location = {
						any_neighbor_province = {
							NOR = {
								county = { same_realm = ROOT }
								culture = ROOT
							}
						}
					}
				}
			}
			random_realm_title = {
				location = {
					random_neighbor_province = {
						limit = {
							NOR = {
								county = { same_realm = ROOT }
								culture = ROOT
							}
						}
						owner = {
							top_liege = {
								log = "Debug: The [This.GetInsultAdjective] [This.GetBestName] ([This.GetID])"
								save_event_target_as = target_enemy_schmuck
							}
						}
					}
				}
			}
		}
		else_if = { # Try and find some random schmuck we can hate on
			limit = {
				any_realm_title = {
					location = {
						any_neighbor_province = {
							NOT = { county = { same_realm = ROOT } }
						}
					}
				}
			}
			random_realm_title = {
				location = {
					random_neighbor_province = {
						limit = {
							NOT = { county = { same_realm = ROOT } }
						}
						owner = {
							top_liege = {
								log = "Debug: The [This.GetInsultAdjective] [This.GetBestName] ([This.GetID])"
								save_event_target_as = target_enemy_schmuck
							}
						}
					}
				}
			}
		}
	}
	
	option = {
		FROMFROM = {
			letter_event = { id = mmc.101 }
		}
	}
}

letter_event = { # Used to notify player of start of whatever event chain
	id = mmc.101
	is_triggered_only = yes # fire from event mmc.100
	border = "GFX_event_letter_frame_war"
	desc = EVTDESC_MMC_100 # Check key for this, GetInsultNoun seems to be screwy
	# Stack when fired by title grant
	# This - title granter
	# ROOT - title granter
	# FROM - title holder
	# FROMFROM - title holder
	# FROMFROMFROM - title granter
	# target_enemy_schmuck - random shmuck
	
	trigger = {
		FROM = {
			has_minor_title = title_mmc_marquis_dornish_marshes
		}
	}
	
	immediate = {
		log = "Debug: event mmc.101"
		print_scope_effect = yes
	}
	
	option = {
		name = {
			text = EVTOPT_OK_MMC_100
			trigger = {
				NOT = { has_house_words_trigger = yes }
			}
		}
		name = {
			text = EVTOPTGETHOUSEWORDS
			trigger = {
				has_house_words_trigger = yes
			}
		}
		custom_tooltip = {
			text = TOOLTIPmmcOK.10
		}
	}
}

province_event = { # Fortifications are built
	id = mmc.110
	hide_window = yes
	
	trigger = {
		owner = { has_minor_title = title_mmc_marquis_dornish_marshes }
		NOT = { has_province_modifier = fortified_marches }
	}
	
	mean_time_to_happen = {
		months = 24
	}
	
	option = {
		owner = {
			character_event = { id = mmc.111 }
		}
	}

}

province_event = { # Ping to province owner to get correct from scoping
	id = mmc.111
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		has_minor_title = title_mmc_marquis_dornish_marshes
	}
	
	option = {
		top_liege = {
			letter_event = { id = mmc.115 }
		}
	}

}

letter_event = { # Liege notification event for adding fortifications
	id = mmc.115
	border = "GFX_event_letter_frame_war"
	desc = EVTDESC_MMC_115
	is_triggered_only = yes
	
	trigger = {
		FROM = {
			has_minor_title = title_mmc_marquis_dornish_marshes
			is_liege_or_above = ROOT
		}
	}
	
	option = {
		name = {
			text = EVTOPT_OK_MMC_100
			trigger = {
				NOT = { has_house_words_trigger = yes }
			}
		}
		name = {
			text = EVTOPTGETHOUSEWORDS
			trigger = {
				has_house_words_trigger = yes
			}
		}
		FROMFROM = {
			add_province_modifier = { modifier = fortified_marches duration = -1 }
		}
	}

}

character_event = {
	id = mmc.999
	is_triggered_only = yes
	hide_window = yes
	
	option = {
		print_scope_effect = yes
	}
}
